# OneRec-Think æ”¯æŒ3ç»´SIDä¿®æ”¹æ€»ç»“

## âœ… ä¿®æ”¹å®Œæˆ

å·²æˆåŠŸä¿®æ”¹OneRec-Thinkä»£ç ä»¥æ”¯æŒKlingæ•°æ®çš„3ç»´SIDæ ¼å¼ã€‚

---

## ğŸ”§ ä¿®æ”¹çš„æ–‡ä»¶ï¼ˆå…±7ä¸ªï¼‰

### æ ¸å¿ƒæ–‡ä»¶
1. âœ… `basemodel/expand_vocab.py` - è¯è¡¨æ‰©å±•ï¼ˆ4ç»´â†’3ç»´ï¼‰

### è®­ç»ƒè„šæœ¬
2. âœ… `train/scripts/train_beauty_align.py`
3. âœ… `train/scripts/train_beauty_sid_rec.py`
4. âœ… `train/scripts/train_beauty_RA.py`

### æµ‹è¯•è„šæœ¬
5. âœ… `test/precompute_global_trie.py`
6. âœ… `test/test_model_hitrate.py`
7. âœ… `test/test_model_hitrate_cot.py`

---

## ğŸ“Š ä¿®æ”¹å†…å®¹

**ä¿®æ”¹å‰**: 
```
<|sid_begin|><s_a_X><s_b_X><s_c_X><s_d_X><|sid_end|>  # 4ç»´
```

**ä¿®æ”¹å**:
```
<|sid_begin|><s_a_X><s_b_X><s_c_X><|sid_end|>  # 3ç»´
```

**å½±å“**:
- ç‰¹æ®Štokenæ•°é‡: 1026 â†’ 770 (-256)
- å®Œå…¨åŒ¹é…Klingæ•°æ®åŸå§‹æ ¼å¼
- æ— éœ€äººå·¥æ·»åŠ ç¬¬4ç»´

---

## ğŸš€ åç»­æ­¥éª¤

### 1. é‡æ–°ç”Ÿæˆæ‰©å±•æ¨¡å‹

```bash
cd /workspace/basemodel
rm -rf Qwen3-1-7B-expand
python expand_vocab.py
```

### 2. å¤„ç†Klingæ•°æ®

```bash
cd /workspace/kling_data
python process_kling_data.py  # åŸå§‹è„šæœ¬ï¼Œå·²ç»æ˜¯3ç»´
```

### 3. ç”Ÿæˆè®­ç»ƒæ•°æ®

```bash
cd /workspace/data
python generate_training_data.py
python generate_sid_prediction_data.py
```

### 4. è®­ç»ƒæ¨¡å‹

```bash
cd /workspace/train
bash run_training_stage1.sh
bash run_training_stage2.sh
```

---

## âœ… éªŒè¯æ–¹æ³•

æ£€æŸ¥æ‰©å±•åçš„æ¨¡å‹è¯è¡¨ï¼š

```python
from transformers import AutoTokenizer

tokenizer = AutoTokenizer.from_pretrained("./basemodel/Qwen3-1-7B-expand")
print(f"è¯è¡¨å¤§å°: {len(tokenizer)}")

# æµ‹è¯•3ç»´SID
test_sid = "<|sid_begin|><s_a_0><s_b_0><s_c_0><|sid_end|>"
tokens = tokenizer.encode(test_sid, add_special_tokens=False)
print(f"3ç»´SIDç¼–ç : {tokens}")
print(f"Tokenæ•°é‡: {len(tokens)}")  # åº”è¯¥æ˜¯5ä¸ªtoken
```

æ£€æŸ¥æ•°æ®æ ¼å¼ï¼š

```python
import json
with open('./kling_data/kling_items.json') as f:
    items = json.load(f)
    sample = list(items.values())[0]
    print(f"ç¤ºä¾‹SID: {sample['sid']}")
    # åº”è¯¥æ˜¯: <|sid_begin|><s_a_X><s_b_X><s_c_X><|sid_end|>
```

---

## ğŸ“š è¯¦ç»†æ–‡æ¡£

æŸ¥çœ‹è¯¦ç»†è¯´æ˜: `cat KLING_3D_SID_MODIFICATION.md`

---

## âš ï¸ é‡è¦æç¤º

1. **å¿…é¡»é‡æ–°è¿è¡Œ** `expand_vocab.py` ç”Ÿæˆæ–°çš„æ‰©å±•æ¨¡å‹
2. **æ—§æ¨¡å‹æ— æ³•ä½¿ç”¨** - 4ç»´æ¨¡å‹ä¸3ç»´æ•°æ®ä¸å…¼å®¹
3. **æ•°æ®æ ¼å¼ç»Ÿä¸€** - ç¡®ä¿æ•´ä¸ªpipelineéƒ½ä½¿ç”¨3ç»´SID

---

**ä¿®æ”¹å®Œæˆæ—¶é—´**: 2025-11-11  
**çŠ¶æ€**: âœ… å·²å®Œæˆï¼Œå¯ä»¥å¼€å§‹è®­ç»ƒ
